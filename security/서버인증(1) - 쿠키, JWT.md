### 서버인증(1) - 세션/쿠키, JWT

웹사이트에서 로그인을 하면 다른 페이지에 들어가도 로그인이 유지된다.

또, `내정보` 와 같은 로그인을 해야만 접속할 수 있는 페이지도 존재한다.

이것을 가능하게 하는 것이 서버 인증이다. 

오늘은 서버인증에서 세션/쿠키와 `JWT`에 대해서 알아보도록 하겠다.

<br>

---

#### 1. Cookie

* 로그인 성공 시 서버에서 쿠키에 사용자 정보를 넣어준다.

* 클라이언트는 브라우저 저장소에 쿠키를 저장하고, 다음 요청마다 쿠키를 서버에 같이 보내준다.

* 서버에서 쿠키를 통해 인증 유무와 유저정보를 알 수 있다.

<br>

> 문제점

* 쿠키에 유저정보가 그대로 들어가기 때문에 유저 정보가 그대로 노출됨.

* 사용자가 임의로 쿠키 값을 변경할 수 있음.

<Br>

이러한 문제점으로 인해 쿠키/세션이 도입된다.

<br>

---

#### 2. Cookie/Session

* 로그인 성공 시 `고유한 ID값`(예측 불가능한 값)을 가지고 있는 세션을 생성한다.

* 해당 세션에 로그인한 사용자의 정보를 `Key-Value` 형태로 서버에 저장한다.

* 사용자는 서버로부터 `세션ID값`을 받아 브라우저에 저장한 후 요청마다 쿠키를 헤더에 실어 보낸다.

* 서버에서는 쿠키의 `세션ID값`으로 세션 저장소에서 대응되는 정보를 가져온다.

* 인증이 완료되면 서버는 사용자의 요청을 수행한다.

<br>

> 장점

* 쿠키가 노출되더라도 `세션ID`는 유의미한 값을 가지지 않는다.

* `세션ID`의 값은 예측 불가능하다.

<br>

> 단점

* 쿠키가 탈취당하게 되면 그 값에 유의미한 값이 존재하지는 않지만, 공격자(해커)가 탈취한 쿠키로 서버에 요청을 보냈을 때 사용자 정보가 노출될 수 있다.(**세션 하이재킹 공격**)

* 서버에서 세션저장소에 대한 추가 저장공간이 요구된다.

<br>

---

#### 3. JWT(Json Web Token) - Access Token

쿠키/세션의 문제점을 개선하기 위해 `Token` 인증방식이 도입되었다. 

* 세션/쿠키의 방식과 유사하게 로그인한 사용자에게 `Access Token(JWT)`을 발급해준다.

* 사용자는 `Access Token을 HTTP` 헤더에 실어 서버로 요청을 보낸다.

* 서버에서는 해당 토큰의 유효성(발급한 토큰이 맞는지, 유효기간이 남았는지)을 검사한다.

* 검증이 완료되면 토큰에 매핑되는 사용자 데이터를 가지고 사용자의 요청을 처리한다.

<br>

자세히보면, 쿠키/세션과 별차이가 없어 보이지만, 중요한 점은 `Access Token`는 탈취당해도 해독하기 쉽지 않게 암호화되고, 세션저장소와 같이 서버에 별도의 저장소를 요구하지 않는다.

이를 알아보기 위해 `JWT`의 구조를 파악해볼 필요가 있다.

> JWT 구조

* `Encoded Header`.`EncodedPayload`.`VerifySignature`로 구성된다.

* **Header**: 암호화 방식과 Type에 대한 정보가 들어간다.

* **Payload**: 서버에 보내는 실제 데이터 값이다.

* **Verify Signature**: **`Header`, `Payload`,`SecretKey`를 더한 후 `Base64방식`으로 인코딩한다.
  
  <br>

이러한 JWT의 구조는 쿠키/세션에는 없는 **안전성을 보장**한다.

`Header`와 `Payload`는 인코딩될 뿐(16진수로 변경), 암호화되지 않는다. 

토큰이 탈취당한다면 쉽게 디코딩하여 Header와 Payload를 볼 수 있다. 

따라서 **Payload에는 중요하지 않은 유저의 ID 정보와 같은 식별자**만 넣는다.

<br>

`VerifySignature`는 암호화되어 `SecretKey`를 알지 못하면 복호화 할 수 없다. 

`SecretKey`는 서버에서 관리하기 때문에 **HTTP 요청에서 탈취당하지 않아** 보안에 좋다. 

<br>

만약 토큰이 탈취당해, `Header`와 `Payload`가 변경된다고 하더라도, 서버에서는 `VerifySignature`를 통해 **토큰의 조작을 감지하고 유효하지 않은 토큰으로 간주**한다.

<br>

> 장점

* JWT는 **Stateless(무상태)특징**을 가지고 있어서 별도의 쿠키/세션과 같이 별도의 저장소를 사용하지 않는다. 

* 토큰기반의 다른 인증시스템(Facebook, Google)등의 접근이 가능하다. 즉, `확장성이` 뛰어나다.

<br>

> 단점

* **Stateless**이기 때문에 JWT를 관리할 수 없다. 쿠키/세션의 경우 탈취당한 세션을 세션저장소에서 삭제하면 되지만, **이미 발급된 토큰에 대해서는 유효기간이 지나기 전까지 사용이 가능**하다. 즉, **토큰을 탈취당하면 변조할 수는 없지만 탈취당한 토큰으로 해당 사용자로 인증이 가능**하다.

* 쿠키/세션에서는 사용자 정보를 세션저장소에서 가져오는 반면, **JWT에서는 Payload의 정보가 제한적**(탈취 방지를 위해)이기 때문에 **사용자의 정보를 가져오기 위해 DB에 접근**해야 한다.

* 쿠키/세션 방식에 비해 JWT의 길이가 길다.(**자원낭비**)

<br>

#Cookie    #Cookie/Session    #JWT    #서버인증
